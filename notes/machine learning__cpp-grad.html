<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>cpp-grad</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/584705cbbef33b49.css" as="style"/><link rel="stylesheet" href="/_next/static/css/584705cbbef33b49.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-83cebdb887f48834.js" defer=""></script><script src="/_next/static/chunks/pages/_app-eb98586f475796ed.js" defer=""></script><script src="/_next/static/chunks/247-fb3f3c148c859656.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5Bnote_id%5D-774c61eb2a4693cc.js" defer=""></script><script src="/_next/static/cgvETiVBVmAniiyDi2eRJ/_buildManifest.js" defer=""></script><script src="/_next/static/cgvETiVBVmAniiyDi2eRJ/_ssgManifest.js" defer=""></script></head><body class="dark:bg-black dark:bg-opacity-95"><div id="__next"><div><nav class="md:sticky md:top-0 md:z-40 shadow-sm p-2 bg-white dark:bg-black dark:shadow-lg dark:shadow-stone-800"><div class="flex items-center"><a class="flex" href="/"><img alt="Profile pic" loading="lazy" width="100" height="100" decoding="async" data-nimg="1" class="rounded-full h-20 w-20 mx-2" style="color:transparent" src="/pfp_blank.png"/><h1 class="self-center text-xl text-stone-400 font-mono dark:text-stone-50 dark:drop-shadow-2xl dark:shadow-white dark:hover:text-stone-200">krkartikay&#x27;s notes</h1></a></div></nav><div class="flex flex-row flex-wrap"><aside class="md:w-1/4 text-stone-500 dark:text-stone-200"><div class="max-w-md mx-auto py-8"><a href="/"><h2 class="p-8 text-lg text-stone-600 hover:bg-stone-100 dark:text-stone-200 dark:hover:bg-stone-800 dark:hover:text-stone-200 ">Notes</h2></a><ul class="list-disc pl-8"><a href="/notes/book%20notes__index"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Book Notes</li></a><ul class="list-disc pl-8"><a href="/notes/book%20notes__if"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">&quot;If&quot;</li></a><a href="/notes/book%20notes__dokkodo"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Dokkodo</li></a><a href="/notes/book%20notes__the%20bhagvad%20gita__index"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">The Bhagvad Gita</li></a><ul class="list-disc pl-8"><a href="/notes/book%20notes__the%20bhagvad%20gita__chapter_1"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Chapter 1</li></a><a href="/notes/book%20notes__the%20bhagvad%20gita__chapter_2"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Chapter 2</li></a></ul><a href="/notes/book%20notes__worry"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Worry</li></a></ul><a href="/notes/economics__index"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Economics</li></a><ul class="list-disc pl-8"><a href="/notes/economics__microeconomics__index"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Microeconomics</li></a><ul class="list-disc pl-8"><a href="/notes/economics__microeconomics__lecture_1"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Lecture 1</li></a><a href="/notes/economics__microeconomics__lecture_2"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Lecture 2</li></a><a href="/notes/economics__microeconomics__lecture_3"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Lecture 3</li></a><a href="/notes/economics__microeconomics__lecture_4"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Lecture 4</li></a><a href="/notes/economics__microeconomics__lecture_5"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Lecture 5</li></a><a href="/notes/economics__microeconomics__lecture_6"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Lecture 6</li></a></ul></ul><a href="/notes/machine%20learning__index"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Machine Learning</li></a><ul class="list-disc pl-8"><a href="/notes/machine%20learning__interview-gpt3"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Interview with GPT-3.5</li></a><a href="/notes/machine%20learning__interview-gpt4"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Interview with GPT-4</li></a><a href="/notes/machine%20learning__cpp-grad"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside font-bold bg-stone-50 dark:bg-stone-800">cpp-grad</li></a></ul><a href="/notes/quotes"><li class="py-2 pl-2 hover:bg-stone-100 hover:text-stone-600 dark:text-stone-400 dark:hover:bg-stone-800 dark:hover:text-stone-200 list-inside ">Quotes</li></a></ul></div></aside><main class="md:w-3/4 border-l-2 dark:border-l-stone-900 border-l-stone-50"><div class="p-8 md:p-16"><br/><h1 class="text-4xl dark:text-white">cpp-grad</h1><p class="text-stone-400 dark:text-stone-300">2023-04-17</p><div class="prose prose-stone dark:prose-invert"><div><hr>
<h1>Reimplementing Micrograd in C++</h1>
<h2>Part 1 â€“ An unexpected error</h2>
<p>I was watching <a href="https://www.youtube.com/watch?v=VMj-3S1tku0">Andrej Karpathy's lecture on micrograd</a> and decided to implement a micrograd-like library in C++. It feels only natural to implement it in C++ because the operations will be more efficient in C++. Also I'd get a chance to write some more C++ code and use some more object oriented features of C++ like operator overloading.</p>
<p>So at first I naively started implementing micrograd, basically doing what Andrej was doing in Python and mentally translating it into C++ code. However at one point I got stuck on an interesting error.</p>
<h3>The code</h3>
<p>The initial part of micrograd is basically about creating an expression graph of variables and operators and using that expression graph to then traverse backward and update the gradients. I had basically created the expression graph and was trying to print it out while traversing it recursively that I noticed a problem.</p>
<p>Here's the code I had till then:</p>
<p><code>main.cpp</code></p>
<pre><code class="hljs language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&#x3C;iostream></span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"engine.h"</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-function">Value <span class="hljs-title">a</span><span class="hljs-params">(<span class="hljs-number">2.0</span>)</span></span>;
  <span class="hljs-function">Value <span class="hljs-title">b</span><span class="hljs-params">(<span class="hljs-number">-3.0</span>)</span></span>;
  <span class="hljs-function">Value <span class="hljs-title">c</span><span class="hljs-params">(<span class="hljs-number">10.0</span>)</span></span>;
  Value d = a * b + c;
  std::cout &#x3C;&#x3C; d.<span class="hljs-built_in">dbg</span>() &#x3C;&#x3C; <span class="hljs-string">"\n"</span>;
}
</code></pre>
<p><code>engine.h</code></p>
<pre><code class="hljs language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&#x3C;iostream></span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&#x3C;ostream></span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&#x3C;set></span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Value</span> {
 <span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Value</span><span class="hljs-params">(<span class="hljs-type">double</span> data)</span> : data_(data) {</span>}

  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Value</span><span class="hljs-params">(<span class="hljs-type">double</span> data, std::set&#x3C;<span class="hljs-type">const</span> Value *> prev, <span class="hljs-type">char</span> op)</span>
      : data_(data), prev_(prev), op_(op){</span>};

  <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">data</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> data_; }

  <span class="hljs-keyword">friend</span> std::ostream &#x26;<span class="hljs-keyword">operator</span>&#x3C;&#x3C;(std::ostream &#x26;out, Value v);

  Value <span class="hljs-keyword">operator</span>+(<span class="hljs-type">const</span> Value &#x26;other) <span class="hljs-type">const</span>;
  Value <span class="hljs-keyword">operator</span>*(<span class="hljs-type">const</span> Value &#x26;other) <span class="hljs-type">const</span>;

  <span class="hljs-function">std::string <span class="hljs-title">dbg</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;

 <span class="hljs-keyword">private</span>:
  <span class="hljs-type">double</span> data_ = <span class="hljs-number">0</span>;
  std::set&#x3C;<span class="hljs-type">const</span> Value *> prev_;
  <span class="hljs-type">char</span> op_ = <span class="hljs-number">0</span>;
};
</code></pre>
<p><code>engine.cpp</code></p>
<pre><code class="hljs language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"engine.h"</span></span>

std::ostream &#x26;<span class="hljs-keyword">operator</span>&#x3C;&#x3C;(std::ostream &#x26;out, Value v) {
  <span class="hljs-keyword">return</span> out &#x3C;&#x3C; <span class="hljs-string">"Value("</span> &#x3C;&#x3C; v.<span class="hljs-built_in">data</span>() &#x3C;&#x3C; <span class="hljs-string">")"</span>;
}

Value Value::<span class="hljs-keyword">operator</span>+(<span class="hljs-type">const</span> Value &#x26;other) <span class="hljs-type">const</span> {
  Value out = <span class="hljs-built_in">Value</span>(<span class="hljs-built_in">data</span>() + other.<span class="hljs-built_in">data</span>(), {<span class="hljs-keyword">this</span>, &#x26;other}, <span class="hljs-string">'*'</span>);
  <span class="hljs-keyword">return</span> out;
}

Value Value::<span class="hljs-keyword">operator</span>*(<span class="hljs-type">const</span> Value &#x26;other) <span class="hljs-type">const</span> {
  Value out = <span class="hljs-built_in">Value</span>(<span class="hljs-built_in">data</span>() * other.<span class="hljs-built_in">data</span>(), {<span class="hljs-keyword">this</span>, &#x26;other}, <span class="hljs-string">'*'</span>);
  <span class="hljs-keyword">return</span> out;
}

<span class="hljs-function">std::string <span class="hljs-title">Value::dbg</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
  <span class="hljs-keyword">if</span> (op_) {
    std::string children_dbg;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> Value *v : prev_) {
      children_dbg += v-><span class="hljs-built_in">dbg</span>() + <span class="hljs-string">", "</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Value(data="</span> + std::<span class="hljs-built_in">to_string</span>(<span class="hljs-built_in">data</span>()) + <span class="hljs-string">",op="</span> + op_ +
           <span class="hljs-string">",prev={"</span> + children_dbg + <span class="hljs-string">"})"</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Value(data="</span> + std::<span class="hljs-built_in">to_string</span>(<span class="hljs-built_in">data</span>()) + <span class="hljs-string">")"</span>;
}
</code></pre>
<p>(Note that Andrej did not define a <code>dbg</code> function like me, instead he had defined a couple of functions to print out the graph in a graphviz format which also renders it in the jupyter notebook, but since I was doing it in C++, the <code>dbg</code> function would have to do for now.)</p>
<h3>The problem:</h3>
<pre><code class="hljs language-sh">@krkartikay âžœ /workspaces/cpp-grad (main) $ make &#x26;&#x26; ./main
g++ main.cpp engine.cpp nn.cpp -o main
Segmentation fault (core dumped)
</code></pre>
<p>So, can you figure out what went wrong? There's only one place where the crash could happen, when we call <code>v->dbg()</code> and dereference the pointer <code>v</code>, because there is no other place where we're dereferencing a pointer. But why did it crash? It looks like we're initialising the pointers with the correct values, and there shouldn't be any <code>nullptr</code>s anywhere. So what's the problem then?</p>
<p>Here's a hint, the code worked when I changed the following lines in <code>main.cpp</code>:</p>
<pre><code class="hljs language-cpp">  Value d = a * b + c;
  std::cout &#x3C;&#x3C; d.<span class="hljs-built_in">dbg</span>() &#x3C;&#x3C; <span class="hljs-string">"\n"</span>;
</code></pre>
<p>to this:</p>
<pre><code class="hljs language-cpp">  Value d = a * b;
  Value e = d + c;
  std::cout &#x3C;&#x3C; e.<span class="hljs-built_in">dbg</span>() &#x3C;&#x3C; <span class="hljs-string">"\n"</span>;
</code></pre>
<p>And this was the output then:</p>
<pre><code>@krkartikay âžœ /workspaces/cpp-grad (main) $ make &#x26;&#x26; ./main
g++ main.cpp engine.cpp nn.cpp -o main
Value(data=4.000000,op=*,prev={Value(data=10.000000), Value(data=-6.000000,op=*,prev={Value(data=2.000000), Value(data=-3.000000), }), })
</code></pre>
<p>So here's basically what's happening. When we are evaluating <code>a * b + c</code>, <code>(a * b)</code> first creates a temporary object that gets added with <code>c</code> and the node <code>d</code> (the output node) contains a pointer to the temporary object <code>(a * b)</code>. This temporary object gets destructed as soon as the expression finishes evaluating and we reach the next line (<code>d.dbg()</code>). So when we call <code>v->dbg()</code> on this node, the <code>v</code> pointer points to a destructed object. This is a problem that wouldn't happen in Python because all objects are created on the heap and the garbage collector takes care of reference counting and doesn't delete this object as it still has one reference.</p>
<h3>The solution</h3>
<p>So how do we solve this problem? I got stuck on this problem because while I understood what's going wrong, the best solution wasn't immediately obvious to me. However after some thinking I decided that maybe doing something like what Python does is the best approach. We can let the Value class be a wrapper for a smart-pointer like object, which creates the actual object on the heap and does the reference counting, while it also has the right operator-overloads for writing expressions like this.</p>
<p>Here's the code I finally got to after I fixed this problem.</p>
<h3>Conclusion</h3>
<p>I realised maybe C++ is not really the best way to do these things. It's probably time to learn PyTorch now.</p></div></div></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note_id":"machine learning__cpp-grad","noteData":{"metadata":{"title":"cpp-grad","date":"2023-04-17"},"content":"\u003chr\u003e\n\u003ch1\u003eReimplementing Micrograd in C++\u003c/h1\u003e\n\u003ch2\u003ePart 1 â€“ An unexpected error\u003c/h2\u003e\n\u003cp\u003eI was watching \u003ca href=\"https://www.youtube.com/watch?v=VMj-3S1tku0\"\u003eAndrej Karpathy's lecture on micrograd\u003c/a\u003e and decided to implement a micrograd-like library in C++. It feels only natural to implement it in C++ because the operations will be more efficient in C++. Also I'd get a chance to write some more C++ code and use some more object oriented features of C++ like operator overloading.\u003c/p\u003e\n\u003cp\u003eSo at first I naively started implementing micrograd, basically doing what Andrej was doing in Python and mentally translating it into C++ code. However at one point I got stuck on an interesting error.\u003c/p\u003e\n\u003ch3\u003eThe code\u003c/h3\u003e\n\u003cp\u003eThe initial part of micrograd is basically about creating an expression graph of variables and operators and using that expression graph to then traverse backward and update the gradients. I had basically created the expression graph and was trying to print it out while traversing it recursively that I noticed a problem.\u003c/p\u003e\n\u003cp\u003eHere's the code I had till then:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emain.cpp\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cpp\"\u003e\u003cspan class=\"hljs-meta\"\u003e#\u003cspan class=\"hljs-keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x3C;iostream\u003e\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"hljs-meta\"\u003e#\u003cspan class=\"hljs-keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"engine.h\"\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003emain\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\n  \u003cspan class=\"hljs-function\"\u003eValue \u003cspan class=\"hljs-title\"\u003ea\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-number\"\u003e2.0\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e;\n  \u003cspan class=\"hljs-function\"\u003eValue \u003cspan class=\"hljs-title\"\u003eb\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-number\"\u003e-3.0\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e;\n  \u003cspan class=\"hljs-function\"\u003eValue \u003cspan class=\"hljs-title\"\u003ec\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-number\"\u003e10.0\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e;\n  Value d = a * b + c;\n  std::cout \u0026#x3C;\u0026#x3C; d.\u003cspan class=\"hljs-built_in\"\u003edbg\u003c/span\u003e() \u0026#x3C;\u0026#x3C; \u003cspan class=\"hljs-string\"\u003e\"\\n\"\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eengine.h\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cpp\"\u003e\u003cspan class=\"hljs-meta\"\u003e#\u003cspan class=\"hljs-keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x3C;iostream\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e#\u003cspan class=\"hljs-keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x3C;ostream\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e#\u003cspan class=\"hljs-keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x3C;set\u003e\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eValue\u003c/span\u003e {\n \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e:\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eexplicit\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eValue\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-type\"\u003edouble\u003c/span\u003e data)\u003c/span\u003e : data_(data) {\u003c/span\u003e}\n\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eexplicit\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eValue\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-type\"\u003edouble\u003c/span\u003e data, std::set\u0026#x3C;\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value *\u003e prev, \u003cspan class=\"hljs-type\"\u003echar\u003c/span\u003e op)\u003c/span\u003e\n      : data_(data), prev_(prev), op_(op){\u003c/span\u003e};\n\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003edouble\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003edata\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e \u003c/span\u003e{ \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e data_; }\n\n  \u003cspan class=\"hljs-keyword\"\u003efriend\u003c/span\u003e std::ostream \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e\u0026#x3C;\u0026#x3C;(std::ostream \u0026#x26;out, Value v);\n\n  Value \u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e+(\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value \u0026#x26;other) \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e;\n  Value \u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e*(\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value \u0026#x26;other) \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-function\"\u003estd::string \u003cspan class=\"hljs-title\"\u003edbg\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e\u003c/span\u003e;\n\n \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e:\n  \u003cspan class=\"hljs-type\"\u003edouble\u003c/span\u003e data_ = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n  std::set\u0026#x3C;\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value *\u003e prev_;\n  \u003cspan class=\"hljs-type\"\u003echar\u003c/span\u003e op_ = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eengine.cpp\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cpp\"\u003e\u003cspan class=\"hljs-meta\"\u003e#\u003cspan class=\"hljs-keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"engine.h\"\u003c/span\u003e\u003c/span\u003e\n\nstd::ostream \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e\u0026#x3C;\u0026#x3C;(std::ostream \u0026#x26;out, Value v) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e out \u0026#x3C;\u0026#x3C; \u003cspan class=\"hljs-string\"\u003e\"Value(\"\u003c/span\u003e \u0026#x3C;\u0026#x3C; v.\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e() \u0026#x3C;\u0026#x3C; \u003cspan class=\"hljs-string\"\u003e\")\"\u003c/span\u003e;\n}\n\nValue Value::\u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e+(\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value \u0026#x26;other) \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e {\n  Value out = \u003cspan class=\"hljs-built_in\"\u003eValue\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e() + other.\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e(), {\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e, \u0026#x26;other}, \u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e out;\n}\n\nValue Value::\u003cspan class=\"hljs-keyword\"\u003eoperator\u003c/span\u003e*(\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value \u0026#x26;other) \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e {\n  Value out = \u003cspan class=\"hljs-built_in\"\u003eValue\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e() * other.\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e(), {\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e, \u0026#x26;other}, \u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e out;\n}\n\n\u003cspan class=\"hljs-function\"\u003estd::string \u003cspan class=\"hljs-title\"\u003eValue::dbg\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (op_) {\n    std::string children_dbg;\n    \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-type\"\u003econst\u003c/span\u003e Value *v : prev_) {\n      children_dbg += v-\u003e\u003cspan class=\"hljs-built_in\"\u003edbg\u003c/span\u003e() + \u003cspan class=\"hljs-string\"\u003e\", \"\u003c/span\u003e;\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Value(data=\"\u003c/span\u003e + std::\u003cspan class=\"hljs-built_in\"\u003eto_string\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e()) + \u003cspan class=\"hljs-string\"\u003e\",op=\"\u003c/span\u003e + op_ +\n           \u003cspan class=\"hljs-string\"\u003e\",prev={\"\u003c/span\u003e + children_dbg + \u003cspan class=\"hljs-string\"\u003e\"})\"\u003c/span\u003e;\n  }\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Value(data=\"\u003c/span\u003e + std::\u003cspan class=\"hljs-built_in\"\u003eto_string\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003edata\u003c/span\u003e()) + \u003cspan class=\"hljs-string\"\u003e\")\"\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e(Note that Andrej did not define a \u003ccode\u003edbg\u003c/code\u003e function like me, instead he had defined a couple of functions to print out the graph in a graphviz format which also renders it in the jupyter notebook, but since I was doing it in C++, the \u003ccode\u003edbg\u003c/code\u003e function would have to do for now.)\u003c/p\u003e\n\u003ch3\u003eThe problem:\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e@krkartikay âžœ /workspaces/cpp-grad (main) $ make \u0026#x26;\u0026#x26; ./main\ng++ main.cpp engine.cpp nn.cpp -o main\nSegmentation fault (core dumped)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo, can you figure out what went wrong? There's only one place where the crash could happen, when we call \u003ccode\u003ev-\u003edbg()\u003c/code\u003e and dereference the pointer \u003ccode\u003ev\u003c/code\u003e, because there is no other place where we're dereferencing a pointer. But why did it crash? It looks like we're initialising the pointers with the correct values, and there shouldn't be any \u003ccode\u003enullptr\u003c/code\u003es anywhere. So what's the problem then?\u003c/p\u003e\n\u003cp\u003eHere's a hint, the code worked when I changed the following lines in \u003ccode\u003emain.cpp\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cpp\"\u003e  Value d = a * b + c;\n  std::cout \u0026#x3C;\u0026#x3C; d.\u003cspan class=\"hljs-built_in\"\u003edbg\u003c/span\u003e() \u0026#x3C;\u0026#x3C; \u003cspan class=\"hljs-string\"\u003e\"\\n\"\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eto this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cpp\"\u003e  Value d = a * b;\n  Value e = d + c;\n  std::cout \u0026#x3C;\u0026#x3C; e.\u003cspan class=\"hljs-built_in\"\u003edbg\u003c/span\u003e() \u0026#x3C;\u0026#x3C; \u003cspan class=\"hljs-string\"\u003e\"\\n\"\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd this was the output then:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e@krkartikay âžœ /workspaces/cpp-grad (main) $ make \u0026#x26;\u0026#x26; ./main\ng++ main.cpp engine.cpp nn.cpp -o main\nValue(data=4.000000,op=*,prev={Value(data=10.000000), Value(data=-6.000000,op=*,prev={Value(data=2.000000), Value(data=-3.000000), }), })\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo here's basically what's happening. When we are evaluating \u003ccode\u003ea * b + c\u003c/code\u003e, \u003ccode\u003e(a * b)\u003c/code\u003e first creates a temporary object that gets added with \u003ccode\u003ec\u003c/code\u003e and the node \u003ccode\u003ed\u003c/code\u003e (the output node) contains a pointer to the temporary object \u003ccode\u003e(a * b)\u003c/code\u003e. This temporary object gets destructed as soon as the expression finishes evaluating and we reach the next line (\u003ccode\u003ed.dbg()\u003c/code\u003e). So when we call \u003ccode\u003ev-\u003edbg()\u003c/code\u003e on this node, the \u003ccode\u003ev\u003c/code\u003e pointer points to a destructed object. This is a problem that wouldn't happen in Python because all objects are created on the heap and the garbage collector takes care of reference counting and doesn't delete this object as it still has one reference.\u003c/p\u003e\n\u003ch3\u003eThe solution\u003c/h3\u003e\n\u003cp\u003eSo how do we solve this problem? I got stuck on this problem because while I understood what's going wrong, the best solution wasn't immediately obvious to me. However after some thinking I decided that maybe doing something like what Python does is the best approach. We can let the Value class be a wrapper for a smart-pointer like object, which creates the actual object on the heap and does the reference counting, while it also has the right operator-overloads for writing expressions like this.\u003c/p\u003e\n\u003cp\u003eHere's the code I finally got to after I fixed this problem.\u003c/p\u003e\n\u003ch3\u003eConclusion\u003c/h3\u003e\n\u003cp\u003eI realised maybe C++ is not really the best way to do these things. It's probably time to learn PyTorch now.\u003c/p\u003e"},"allNotesIndex":{"base_name":"notes","full_path":"/home/runner/work/krkartikay.github.io/krkartikay.github.io/notes","notes_data":[{"id":"quotes","metadata":{"title":"Quotes","date":"2023-03-21"}}],"directories":[{"base_name":"book notes","full_path":"/home/runner/work/krkartikay.github.io/krkartikay.github.io/notes/book notes","notes_data":[{"id":"dokkodo","metadata":{"title":"Dokkodo","date":"2023-03-23"}},{"id":"if","metadata":{"title":"\"If\"","date":"2023-03-27"}},{"id":"worry","metadata":{"title":"Worry","date":"2023-03-29"}}],"directories":[{"base_name":"the bhagvad gita","full_path":"/home/runner/work/krkartikay.github.io/krkartikay.github.io/notes/book notes/the bhagvad gita","notes_data":[{"id":"chapter_1","metadata":{"title":"Chapter 1","date":"2023-04-06"}},{"id":"chapter_2","metadata":{"title":"Chapter 2","date":"2023-04-08"}},{"id":"index","metadata":{"title":"The Bhagvad Gita","date":"2023-04-06"}}],"directories":[]}]},{"base_name":"economics","full_path":"/home/runner/work/krkartikay.github.io/krkartikay.github.io/notes/economics","notes_data":[],"directories":[{"base_name":"microeconomics","full_path":"/home/runner/work/krkartikay.github.io/krkartikay.github.io/notes/economics/microeconomics","notes_data":[{"id":"index","metadata":{"title":"Principles of Microeconomics","date":"2023-03-23"}},{"id":"lecture_1","metadata":{"title":"Lecture 1","date":"2023-03-23"}},{"id":"lecture_2","metadata":{"title":"Lecture 2","date":"2023-03-23"}},{"id":"lecture_3","metadata":{"title":"Lecture 3","date":"2023-03-23"}},{"id":"lecture_4","metadata":{"title":"Lecture 4","date":"2023-04-01"}},{"id":"lecture_5","metadata":{"title":"Lecture 5","date":"2023-04-01"}},{"id":"lecture_6","metadata":{"title":"Lecture 6","date":"2023-04-01"}}],"directories":[]}]},{"base_name":"machine learning","full_path":"/home/runner/work/krkartikay.github.io/krkartikay.github.io/notes/machine learning","notes_data":[{"id":"cpp-grad","metadata":{"title":"cpp-grad","date":"2023-04-17"}},{"id":"interview-gpt3","metadata":{"title":"Interview with GPT-3.5","date":"2023-04-21"}},{"id":"interview-gpt4","metadata":{"title":"Interview with GPT-4","date":"2023-04-21"}}],"directories":[]}]}},"__N_SSG":true},"page":"/notes/[note_id]","query":{"note_id":"machine learning__cpp-grad"},"buildId":"cgvETiVBVmAniiyDi2eRJ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>